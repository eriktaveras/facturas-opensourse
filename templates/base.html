<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}InvoiceFlow Enterprise{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gray: { 50: '#f9fafb', 100: '#f3f4f6', 200: '#e5e7eb', 800: '#1f2937', 900: '#111827' },
                        primary: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 900: '#0c4a6e' }
                    },
                    fontFamily: {
                        'sans': ['Manrope', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    boxShadow: {
                        'subtle': '0 1px 2px 0 rgba(0, 0, 0, 0.05)',
                        'card': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)'
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        
        /* Scrollbar refinado y fino */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Chat Animations - Swift and professional */
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up { animation: slideInUp 0.2s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        
        .prose p { margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .prose strong { font-weight: 600; color: #0f172a; }
    </style>
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-slate-50 h-screen flex overflow-hidden font-sans text-slate-600 antialiased selection:bg-slate-200 selection:text-slate-900" {% block body_attrs %}{% endblock %}>
<div class="h-full w-full flex overflow-hidden">

    <!-- 1. SIDEBAR (Izquierda) - Estilo Brex/Stripe (Clean Dark) -->
    <aside class="fixed inset-y-0 left-0 w-64 bg-slate-950 text-slate-400 flex flex-col z-40 border-r border-slate-800 transform transition-transform duration-300 -translate-x-full lg:translate-x-0 lg:static lg:flex-shrink-0"
           :class="$store.layout.drawerOpen ? 'translate-x-0' : '-translate-x-full'">
        
        <!-- Logo Area -->
        <div class="h-16 flex items-center px-6 border-b border-slate-800/60 justify-between">
            <div class="flex items-center gap-3 text-white">
                <div class="bg-white text-slate-900 p-1.5 rounded-md">
                    <i class="fas fa-layer-group text-sm"></i>
                </div>
                <span class="font-semibold tracking-tight text-sm">InvoiceFlow</span>
            </div>
            <button class="lg:hidden text-slate-400 hover:text-white" @click="$store.layout.drawerOpen = false">
                <i class="fas fa-xmark"></i>
            </button>
        </div>

        <!-- Menú Principal -->
        <nav class="flex-1 overflow-y-auto px-3 py-6 space-y-1 custom-scrollbar">
            
            <p class="px-3 text-[10px] font-semibold text-slate-500 uppercase tracking-widest mb-2">Workspace</p>
            
            <a href="/?tab=dashboard" 
               :class="isActive('dashboard') ? 'bg-slate-900 text-white' : 'hover:bg-slate-900/60 hover:text-slate-200'"
               class="group flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors duration-150">
                <i class="fas fa-home w-5 text-center mr-3 text-xs" :class="isActive('dashboard') ? 'text-white' : 'text-slate-500'"></i>
                Dashboard
            </a>

            <a href="/?tab=invoices" 
               :class="isActive('invoices') ? 'bg-slate-900 text-white' : 'hover:bg-slate-900/60 hover:text-slate-200'"
               class="group flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors duration-150">
                <i class="fas fa-file-alt w-5 text-center mr-3 text-xs" :class="isActive('invoices') ? 'text-white' : 'text-slate-500'"></i>
                Facturas
            </a>

            <a href="/reports" 
               :class="window.location.pathname.startsWith('/reports') ? 'bg-slate-900 text-white' : 'hover:bg-slate-900/60 hover:text-slate-200'"
               class="group flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors duration-150">
                <i class="fas fa-chart-pie w-5 text-center mr-3 text-xs" :class="window.location.pathname.startsWith('/reports') ? 'text-white' : 'text-slate-500'"></i>
                Analítica
            </a>

            <a href="/?tab=upload" 
               :class="isActive('upload') ? 'bg-slate-900 text-white' : 'hover:bg-slate-900/60 hover:text-slate-200'"
               class="group flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors duration-150">
                <i class="fas fa-arrow-up w-5 text-center mr-3 text-xs" :class="isActive('upload') ? 'text-white' : 'text-slate-500'"></i>
                Pipeline de Carga
            </a>

            <div class="my-6 border-t border-slate-800 mx-2"></div>
            
            <p class="px-3 text-[10px] font-semibold text-slate-500 uppercase tracking-widest mb-2">Configuración</p>

            <a href="/settings" 
               :class="window.location.pathname.startsWith('/settings') ? 'bg-slate-900 text-white' : 'hover:bg-slate-900/60 hover:text-slate-200'"
               class="group flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors duration-150">
                <i class="fas fa-sliders-h w-5 text-center mr-3 text-xs" :class="window.location.pathname.startsWith('/settings') ? 'text-white' : 'text-slate-500'"></i>
                Ajustes & API
            </a>
        </nav>

        <!-- User Footer (Minimalist) -->
        <div class="p-4 border-t border-slate-800 bg-slate-950">
            <a href="/logout" class="flex items-center w-full group">
                <div class="h-8 w-8 rounded bg-slate-800 flex items-center justify-center text-white font-medium text-xs border border-slate-700">
                    {{ user.full_name[:2].upper() if user and user.full_name else 'ET' }}
                </div>
                <div class="ml-3 overflow-hidden flex-1">
                    <p class="text-xs font-medium text-slate-300 group-hover:text-white transition-colors truncate">{{ user.full_name if user else 'Erik Taveras' }}</p>
                    <p class="text-[10px] text-slate-500 truncate">Cerrar Sesión</p>
                </div>
                <i class="fas fa-sign-out-alt text-slate-600 group-hover:text-slate-400 text-xs"></i>
            </a>
        </div>
    </aside>

    <!-- 2. MAIN WRAPPER (Centro) -->
    <div class="flex-1 flex flex-col min-w-0 overflow-hidden bg-white">
        
        <!-- 2a. TOPBAR (Solid & Clean) -->
        <header class="min-h-[64px] bg-white border-b border-slate-200 flex flex-wrap items-center justify-between px-4 md:px-8 py-3 md:py-0 z-20 sticky top-0 gap-4">
            <!-- Left: Context / Breadcrumbs (Placeholder) -->
            <div class="flex items-center flex-1 gap-3 min-w-0">
                <button class="inline-flex items-center justify-center h-9 w-9 rounded-lg border border-slate-200 text-slate-500 hover:text-slate-900 hover:bg-slate-50 lg:hidden"
                        @click="$store.layout.drawerOpen = true">
                    <i class="fas fa-bars text-xs"></i>
                </button>
                <div class="text-sm font-medium text-slate-500 flex items-center gap-2 min-w-0">
                    <span class="text-[10px] uppercase tracking-[0.2em] text-slate-400 hidden sm:inline">Workspace</span>
                    <span class="text-slate-900 truncate max-w-[160px] sm:max-w-none">{{ company_name or 'Mi Empresa S.A.' }}</span>
                    <span class="text-slate-300 hidden sm:inline">/</span>
                    <span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded text-xs border border-slate-200 hidden sm:inline">{{ company_plan or 'Free Plan' }}</span>
                    {% if company_tax_id %}
                    <span class="hidden md:inline-flex items-center gap-1 bg-white text-slate-500 px-2 py-0.5 rounded text-[10px] border border-slate-200">
                        <i class="fas fa-id-card text-[9px] text-slate-400"></i>
                        RNC {{ company_tax_id }}
                    </span>
                    {% endif %}
                    {% if user and user.email %}
                    <span class="hidden md:inline-flex items-center gap-1 bg-white text-slate-500 px-2 py-0.5 rounded text-[10px] border border-slate-200">
                        <i class="fas fa-user text-[9px] text-slate-400"></i>
                        {{ user.email }}
                    </span>
                    {% endif %}
                </div>
            </div>

            <!-- Right: Search & Actions -->
            <div class="flex items-center flex-wrap gap-4 md:gap-6">
                
                <!-- Search Input (Clean) -->
                <div class="relative w-full sm:w-64 group">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400 group-focus-within:text-slate-600">
                        <i class="fas fa-search text-xs"></i>
                    </span>
                    <input id="globalSearchInput" type="text" 
                           class="block w-full rounded-lg border border-slate-200 bg-slate-50 py-1.5 pl-9 pr-3 text-xs text-slate-900 placeholder-slate-400 focus:border-slate-400 focus:bg-white focus:ring-0 transition-colors" 
                           placeholder="Buscar (⌘K)">
                </div>

                <div class="h-4 w-px bg-slate-200 hidden sm:block"></div>

                <!-- Notifications -->
                <div class="relative" x-data="{ open: false, notifications: [] }" 
                     x-init="
                        fetch('/api/notifications?unread_only=true&limit=5').then(r => r.json()).then(data => notifications = data);
                        $watch('notifications', val => $dispatch('notification-update', val));
                        window.addEventListener('notification-received', e => {
                            notifications.unshift(e.detail);
                            if(notifications.length > 5) notifications.pop();
                        });
                     ">
                    <button @click="open = !open" class="relative text-slate-400 hover:text-slate-600 transition-colors focus:outline-none">
                        <i class="far fa-bell text-lg"></i>
                        <span x-show="notifications.some(n => !n.read)" class="absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"></span>
                    </button>
                    
                    <!-- Dropdown (Clean) -->
                    <div x-show="open" @click.away="open = false" x-cloak
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="opacity-0 scale-95"
                         x-transition:enter-end="opacity-100 scale-100"
                         class="absolute right-0 mt-2 w-80 rounded-lg shadow-lg bg-white ring-1 ring-black/5 focus:outline-none z-50 overflow-hidden border border-slate-100">
                        <div class="py-1">
                            <div class="px-4 py-2 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                <span class="text-xs font-semibold text-slate-700 uppercase tracking-wider">Notificaciones</span>
                                <button @click="fetch('/api/notifications/read-all', {method: 'POST'}).then(() => notifications = [])" 
                                        class="text-[10px] text-slate-700 hover:text-slate-900 font-medium hover:underline">
                                    Limpiar
                                </button>
                            </div>
                            <div class="max-h-64 overflow-y-auto custom-scrollbar">
                                <template x-for="notif in notifications" :key="notif.id">
                                    <div class="px-4 py-3 hover:bg-slate-50 transition-colors border-b border-slate-50 last:border-0">
                                        <div class="flex items-start">
                                            <div class="flex-shrink-0 mt-0.5 mr-3">
                                                <i class="fas text-xs"
                                                   :class="{
                                                       'fa-check-circle text-green-500': notif.type === 'success',
                                                       'fa-times-circle text-red-500': notif.type === 'error',
                                                       'fa-exclamation-circle text-yellow-500': notif.type === 'warning',
                                                       'fa-info-circle text-blue-500': notif.type === 'info'
                                                   }"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p class="text-sm font-medium text-slate-900" x-text="notif.title"></p>
                                                <p class="text-xs text-slate-500 mt-0.5" x-text="notif.message"></p>
                                                <p class="text-[10px] text-slate-400 mt-1" x-text="notif.time_ago"></p>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                                <div x-show="notifications.length === 0" class="px-4 py-8 text-center">
                                    <p class="text-xs text-slate-400">Sin notificaciones nuevas</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CTA: Create Invoice -->
                <a href="/?tab=upload" class="hidden sm:inline-flex items-center px-4 py-2 bg-slate-900 hover:bg-slate-800 text-white text-xs font-semibold rounded-md shadow-sm transition-all duration-200">
                    <i class="fas fa-plus mr-2"></i> Nuevo
                </a>
            </div>
        </header>

        <!-- 2b. CONTENT AREA -->
        <main class="flex-1 overflow-auto p-4 md:p-8 custom-scrollbar bg-slate-50/60">
            <div class="max-w-7xl mx-auto">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <!-- CFO Virtual Floating Chat (Minimalist) -->
    <div class="fixed bottom-6 right-6 z-50 flex flex-col items-end space-y-4 font-sans" x-cloak x-data="cfoChat()">
        
        <!-- Chat Window -->
        <div x-show="isOpen" 
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 translate-y-4 scale-95"
             x-transition:enter-end="opacity-100 translate-y-0 scale-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 translate-y-0 scale-100"
             x-transition:leave-end="opacity-0 translate-y-4 scale-95"
             class="w-[360px] h-[500px] bg-white rounded-xl shadow-xl border border-slate-200 flex flex-col overflow-hidden">
            
            <!-- Header -->
            <div class="bg-white border-b border-slate-100 p-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded bg-slate-100 flex items-center justify-center text-slate-700 border border-slate-200">
                        <i class="fas fa-robot text-sm"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-sm text-slate-900">Asistente de Datos</h3>
                        <div class="flex items-center gap-1.5">
                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                            <span class="text-[10px] text-slate-500 font-medium">Motor IA activo</span>
                        </div>
                    </div>
                </div>
                <button @click="isOpen = false" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Messages Area -->
            <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 custom-scrollbar" x-ref="chatContainer">
                <!-- Welcome -->
                <div class="flex items-start gap-3 animate-slide-up">
                    <div class="w-6 h-6 rounded bg-white border border-slate-200 flex items-center justify-center flex-shrink-0 text-slate-600 mt-0.5">
                        <i class="fas fa-robot text-[10px]"></i>
                    </div>
                    <div class="bg-white p-3 rounded-lg border border-slate-200 text-sm text-slate-600 shadow-sm max-w-[90%]">
                        <p>Hola. Puedo ayudarte a interpretar la extracción, detectar inconsistencias y resumir datos de facturas. ¿Qué necesitas?</p>
                    </div>
                </div>

                <!-- Messages -->
                <template x-for="(msg, index) in messages" :key="index">
                    <div class="flex items-start gap-3 animate-slide-up" :class="msg.isUser ? 'flex-row-reverse' : ''">
                        <div class="w-6 h-6 rounded flex items-center justify-center flex-shrink-0 mt-0.5 text-white text-[10px]"
                             :class="msg.isUser ? 'bg-slate-900' : 'bg-white border border-slate-200 text-slate-600'">
                            <i class="fas" :class="msg.isUser ? 'fa-user' : 'fa-robot'"></i>
                        </div>
                        <div class="p-3 rounded-lg text-sm shadow-sm max-w-[90%]"
                             :class="msg.isUser ? 'bg-slate-900 text-white' : 'bg-white text-slate-700 border border-slate-200'">
                            <div class="prose prose-sm prose-invert max-w-none break-words" x-html="renderMarkdown(msg.text)"></div>
                        </div>
                    </div>
                </template>

                <!-- Loading -->
                <div x-show="isLoading" class="flex items-start gap-3 animate-pulse">
                    <div class="w-6 h-6 rounded bg-white border border-slate-200 flex items-center justify-center flex-shrink-0 text-slate-600">
                        <i class="fas fa-robot text-[10px]"></i>
                    </div>
                    <div class="bg-white px-3 py-2 rounded-lg border border-slate-200 shadow-sm flex gap-1">
                        <div class="w-1 h-1 bg-slate-400 rounded-full animate-bounce"></div>
                        <div class="w-1 h-1 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-1 h-1 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-3 bg-white border-t border-slate-100">
                <!-- Suggestions -->
                <div class="flex gap-2 mb-3 overflow-x-auto pb-1 scrollbar-hide" x-show="messages.length < 2">
                    <button @click="askQuestion('Resumen de extracción de hoy')" class="whitespace-nowrap px-3 py-1.5 rounded-md bg-slate-50 hover:bg-slate-100 text-xs font-medium text-slate-600 border border-slate-200 transition-colors">
                        Resumen de hoy
                    </button>
                    <button @click="askQuestion('¿Qué facturas tienen campos incompletos?')" class="whitespace-nowrap px-3 py-1.5 rounded-md bg-slate-50 hover:bg-slate-100 text-xs font-medium text-slate-600 border border-slate-200 transition-colors">
                        Campos incompletos
                    </button>
                    <button @click="askQuestion('Facturas recibidas por WhatsApp hoy')" class="whitespace-nowrap px-3 py-1.5 rounded-md bg-slate-50 hover:bg-slate-100 text-xs font-medium text-slate-600 border border-slate-200 transition-colors">
                        WhatsApp hoy
                    </button>
                </div>

                <div class="relative flex items-center">
                    <input type="text" 
                           x-model="currentInput" 
                           @keydown.enter="sendMessage()"
                           placeholder="Pregunta algo..." 
                           class="w-full pl-3 pr-10 py-2 rounded-md bg-white border border-slate-300 focus:border-slate-500 focus:ring-1 focus:ring-slate-500 text-sm transition-shadow placeholder-slate-400">
                    
                    <button @click="sendMessage()" 
                            :disabled="!currentInput.trim() || isLoading"
                            class="absolute right-1.5 p-1.5 text-slate-400 hover:text-slate-900 disabled:opacity-50 transition-colors">
                        <i class="fas fa-arrow-up text-sm"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Floating Button (FAB) - Minimalist Black -->
        <button @click="toggleChat()" 
                class="w-12 h-12 bg-slate-900 text-white rounded-full shadow-lg hover:shadow-xl hover:bg-slate-800 transition-all duration-200 flex items-center justify-center group relative ring-4 ring-white/50">
            <i class="fa-solid fa-comment-dots text-sm relative z-10 transition-transform duration-300" x-show="!isOpen"></i>
            <i class="fas fa-times text-sm relative z-10" x-show="isOpen"></i>
            <span class="absolute top-0 right-0 w-3 h-3 bg-red-500 border-2 border-slate-900 rounded-full z-20" x-show="!isOpen && hasUnread"></span>
        </button>
    </div>

    <!-- WhatsApp Notification Toast (High Visibility) -->
    <div x-data="{ show: false, data: {} }" 
         x-init="window.addEventListener('notification-received', e => {
             if (e.detail.type === 'info' && e.detail.title === 'Nuevo Mensaje WhatsApp') {
                 // Parse data if it's a string, otherwise use as is
                 let payload = e.detail.data;
                 if (typeof payload === 'string') {
                    try { payload = JSON.parse(payload); } catch(e) {}
                 }
                 data = payload;
                 show = true;
                 setTimeout(() => show = false, 8000);
                 const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
                 audio.volume = 0.5;
                 audio.play().catch(e => console.log('Audio play failed', e));
             }
         })"
         x-show="show" x-cloak
         x-transition:enter="transition ease-out duration-500"
         x-transition:enter-start="opacity-0 translate-x-12"
         x-transition:enter-end="opacity-100 translate-x-0"
         x-transition:leave="transition ease-in duration-300"
         x-transition:leave-start="opacity-100 translate-x-0"
         x-transition:leave-end="opacity-0 translate-x-12"
         class="fixed top-24 right-6 z-[60] w-96 bg-white rounded-xl shadow-2xl border-l-4 border-[#25D366] overflow-hidden cursor-pointer hover:shadow-xl transition-shadow"
         @click="window.location.href = `/?tab=invoices`">
        
        <div class="p-5 relative">
            <!-- Background Decoration -->
            <div class="absolute top-0 right-0 -mt-2 -mr-2 opacity-10">
                <i class="fab fa-whatsapp text-8xl text-[#25D366]"></i>
            </div>

            <div class="flex items-start space-x-4 relative z-10">
                <!-- Icon -->
                <div class="flex-shrink-0">
                    <div class="h-12 w-12 rounded-full bg-[#25D366]/10 flex items-center justify-center">
                        <i class="fab fa-whatsapp text-2xl text-[#25D366]"></i>
                    </div>
                </div>
                
                <!-- Content -->
                <div class="flex-1 min-w-0">
                    <p class="text-[10px] font-bold text-[#25D366] uppercase tracking-wider mb-0.5">Nueva Factura Recibida</p>
                    <h3 class="text-sm font-bold text-gray-900 truncate" x-text="data.sender?.name || 'Usuario WhatsApp'"></h3>
                    <p class="text-xs text-gray-500 mb-3" x-text="data.sender?.phone || ''"></p>
                    
                    <!-- Progress Bar / Status -->
                    <div class="flex items-center space-x-2">
                        <span class="relative flex h-2 w-2">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-indigo-500"></span>
                        </span>
                        <span class="text-[10px] font-medium text-indigo-600 animate-pulse">Procesando con IA...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Action Footer -->
        <div class="bg-gray-50 px-5 py-3 border-t border-gray-100 flex justify-between items-center">
            <span class="text-[10px] text-gray-400 font-mono" x-text="'ID: #' + (data.invoice_id || '...')"></span>
            <button class="text-xs font-bold text-gray-900 hover:text-[#25D366] transition-colors flex items-center">
                Ver documento <i class="fas fa-arrow-right ml-1"></i>
            </button>
        </div>
    </div>

    <!-- Drawer Overlay -->
    <div x-show="$store.layout.drawerOpen" x-cloak class="fixed inset-0 bg-slate-900/30 backdrop-blur-sm transition-opacity z-30 lg:hidden" @click="$store.layout.drawerOpen = false"></div>
</div>

    <script>
        function isActive(tabName) {
            const params = new URLSearchParams(window.location.search);
            const currentTab = params.get('tab') || 'dashboard'; 
            return window.location.pathname === '/' && currentTab === tabName;
        }

        function initGlobalSearch() {
            const input = document.getElementById('globalSearchInput');
            if (!input) return;
            input.addEventListener('keydown', (e) => {
                if (e.key !== 'Enter') return;
                const term = input.value.trim();
                if (!term) return;
                const params = new URLSearchParams(window.location.search);
                params.set('tab', 'invoices');
                params.set('search', term);
                window.location.href = `/?${params.toString()}`;
            });
        }

        function cfoChat() {
            return {
                isOpen: false,
                isLoading: false,
                currentInput: '',
                messages: [],
                hasUnread: true,

                init() {},

                toggleChat() {
                    this.isOpen = !this.isOpen;
                    if (this.isOpen) {
                        this.hasUnread = false;
                        this.$nextTick(() => this.scrollToBottom());
                    }
                },

                scrollToBottom() {
                    const container = this.$refs.chatContainer;
                    if(container) container.scrollTop = container.scrollHeight;
                },

                askQuestion(text) {
                    this.currentInput = text;
                    this.sendMessage();
                },

                renderMarkdown(text) {
                    if (typeof marked !== 'undefined') {
                        return marked.parse(text);
                    }
                    return text;
                },

                async sendMessage() {
                    const text = this.currentInput.trim();
                    if (!text || this.isLoading) return;

                    this.messages.push({ text: text, isUser: true });
                    this.currentInput = '';
                    this.isLoading = true;
                    this.$nextTick(() => this.scrollToBottom());

                    try {
                        const res = await fetch('/api/chat/finance', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ query: text })
                        });
                        
                        if (!res.ok) throw new Error('Error de red');
                        
                        const data = await res.json();
                        this.messages.push({ text: data.answer, isUser: false });
                        
                    } catch (e) {
                        console.error(e);
                        this.messages.push({ 
                            text: '⚠️ Error de conexión. Intenta de nuevo.', 
                            isUser: false 
                        });
                    } finally {
                        this.isLoading = false;
                        this.$nextTick(() => this.scrollToBottom());
                    }
                }
            }
        }
    </script>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.store('layout', { drawerOpen: false });
        });

        document.addEventListener('DOMContentLoaded', () => {
            initGlobalSearch();
        });
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
